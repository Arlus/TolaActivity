{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block content %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/select2.min.css">
    <script type="text/javascript" src="{{ STATIC_URL }}js/select2.min.js"></script>
    <script src="{{ STATIC_URL }}publicdashboard/js/vendor/Chart.min.js"></script>
    <script type="text/javascript">

    $(document).ready(function() {
        $("#countries").select2({ placeholder: "Country", allowClear: true });
        $("#id_sector").select2({placeholder: "Sector", allowClear: true,});
        $("#id_program").select2({placeholder: "Program", allowClear: true,});
        $('.dateinput').datepicker({  dateFormat: 'yy-mm-dd', });

            //Show the program table
            function show_program_table(drillupdown_data) {
                myRecords = JSON.parse(drillupdown_data);
                //First destroy any old version of the table to refresh anew
                if ( $.fn.dataTable.isDataTable( '#program_table' ) ) {
                    table.destroy();
                };
                table = $('#program_table').DataTable( {
                    retrieve: true,
                    data: myRecords,
                    columns: [
                        { title: "Sector" ,data: "sector__sector"},
                        { title: "Name" ,data: "name"},
                        { title: "Country" ,data: "country__country"},
                        { title: "Cost Center" ,data: "cost_center"},
                        { title: "Gaitid" ,data: "gaitid"},
                        { title: "Funding Status" ,data: "funding_status"}
                        ]
                } );

            }

            function show_program_charts(project_count,approval_count,approved_count,inprogress_count,rejected_count) {
                document.getElementById('doughnut1-header').innerHTML = "Project Status";
                //render project_status in a doughnut chart
                var status_options = {
                    // single tooltip
                    tooltipTemplate: "<%=label + ' Projects' %>",
                };
                var status_data = [
                    {
                    value: approved_count,
                    color:"#637b85",
                    label: "Approved " + approved_count
                    },
                    {
                    value : approval_count,
                    color : "#2c9c69",
                    label: "Waiting " + approval_count
                    },
                    {
                    value : rejected_count,
                    color : "#dbba34",
                    label: "Rejected " + rejected_count
                    },
                    {
                    value : inprogress_count,
                    color : "#c62f29",
                    label: "In Progress " + inprogress_count
                    }
                ];
                var ctx = document.getElementById("doughnut1").getContext("2d");
                var statusChart = new Chart(ctx).Doughnut(status_data,status_options);
                document.getElementById('doughnut1-legend').innerHTML = statusChart.generateLegend();

                $("#doughnut1").click(
                    function(evt){
                        var activePoints = statusChart.getSegmentsAtEvent(evt);
                        var url = "/reports/report/" + activePoints[0].label + "&value=" + activePoints[0].value;
                        alert(url);
                    }
                );
            };

            function show_indicator_charts(indicator_count,evidence_count) {
                document.getElementById('doughnut2-header').innerHTML = "Indicator Chart";
                //render indicator data in a doughnut chart
                var indicator_options = {
                    // single tooltip
                    tooltipTemplate: "<%=label + ' Indicator' %>",
                };

                //adjust indicator count
                adjusted_indicator_count = indicator_count - evidence_count

                var indicator_data = [

                    {
                    value: adjusted_indicator_count,
                    color:"#637b85",
                    label: "Indicators " + adjusted_indicator_count
                    },
                    {
                    value: evidence_count,
                    color:"#2c9c69",
                    label: "Evidence " + evidence_count
                    },
                ];
                var ctx = document.getElementById("doughnut2").getContext("2d");
                var indicatorChart = new Chart(ctx).Doughnut(indicator_data,indicator_options);
                document.getElementById('doughnut2-legend').innerHTML = indicatorChart.generateLegend();

                $("#doughnut2").click(
                    function(evt){
                        var activePoints = indicatorChart.getSegmentsAtEvent(evt);
                        var url = "/reports/report/" + activePoints[0].label + "&value=" + activePoints[0].value;
                        alert(url);
                    }
                );
            };


            // Upon search form submission, format filter values so Django understands it.
            $('#filter_form').on('submit', function(e) {
                //show panels for data after submit
                $("#welcome-panel").hide();
                $('#data-panel').removeClass('hidden');
                $("#data-panel").show();
                $('#criteria-panel').removeClass('hidden');
                $("#criteria-panel").show();

                e.preventDefault();
                var filters = {};
                $('#filter_form *').filter(':input').each(function() {
                    if (this.name != 'submit' && this.name != 'reset' && this.value && this.name != '') {
                        var values_array = new Array($(this).val());
                        filters[this.name] = values_array.join(",");
                    }
                });

                $.getJSON("/reports/report_data/", filters, function(data) {

                    var criteria = data['criteria'];

                    //console.log(data['program']);
                    show_program_table(data['program']);
                    show_program_charts(data['project_count'],data['approval_count'],data['approved_count'],data['inprogress_count'],data['rejected_count']);
                    show_indicator_charts(data['indicator_count'], data['evidence_count']);
                    var formatted_criteria = format_criteria(criteria);

                $("#criteria").html(formatted_criteria);
                $("#criteria-panel").show();

            });
        });

    });
</script>

    <div class="row">
        <div class="col-sm-3">
            <div class="panel panel-primary">
                <div class="panel-heading"><span class="glyphicon glyphicon-filter"> </span> Filter options </div>
                <div class="panel-body">
                    {% crispy form form.helper %}
                </div>
            </div>
        </div>
        <div class="col-sm-9">
            <div id='welcome-panel' class="panel panel-success">
                <div class="panel-heading"> Program Filter Reports</div>
                <div class="panel-body" id="welcome" style="padding:5px;"> Filter your search in the panel on the left to see results.</div>
            </div>
            <div id='data-panel' class="panel panel-primary" style="display: none;">
                <div class="panel-heading"></div>
                <div class="panel-body" style="padding:15px;">
                    <div id="program_chart">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <h4 class="chart-title" id="doughnut1-header"></h4>
                                    <div class="col-md-7">
                                        <canvas id="doughnut1" width="200" height="200"></canvas>
                                    </div>
                                    <div class="col-md-3">
                                        <div id="doughnut1-legend" class="chart-legend"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <h4 class="chart-title" id="doughnut2-header"></h4>
                                    <div class="col-md-7">
                                        <canvas id="doughnut2" width="200" height="200"></canvas>
                                    </div>
                                    <div class="col-md-3">
                                        <div id="doughnut2-legend" class="chart-legend"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="program_table_div">
                        <table class="table table-bordered" id="program_table">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}